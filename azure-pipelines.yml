# Basic Azure Pipeline for .NET Application with Azure Web App Deployment
# This pipeline builds, tests, and deploys the application to Azure Web App Service

trigger:
- main
- develop

parameters:
- name: enableDeployment
  displayName: 'Enable Deployment to Azure'
  type: boolean
  default: false
- name: azureServiceConnection
  displayName: 'Azure Service Connection Name'
  type: string
  default: 'Azure-BasicDotnetApp-Connection'
- name: webAppName
  displayName: 'Azure Web App Name'
  type: string
  default: 'basic-modern-dotnet-webapp'
- name: resourceGroupName
  displayName: 'Azure Resource Group Name'
  type: string
  default: 'rg-basic-dotnet-webapp'

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'
  dotNetVersion: '10.0.x'

stages:
- stage: BuildAndTest
  displayName: 'Build and Test Application'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET Application'
    steps:
    
    - task: UseDotNet@2
      displayName: 'Install .NET 10 SDK'
      inputs:
        packageType: 'sdk'
        version: $(dotNetVersion)
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'
        feedsToUse: 'select'
    
    - task: DotNetCoreCLI@2
      displayName: 'Build Application'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore --verbosity normal'
    
    - script: |
        echo "=== Build Information ==="
        echo "Build Configuration: $(buildConfiguration)"
        echo "Target Framework: net10.0"
        echo "Build Date: $(Build.BuildNumber)"
        echo "Source Branch: $(Build.SourceBranch)"
        echo "Build ID: $(Build.BuildId)"
        echo ""
        echo "=== Application Files ==="
        ls -la $(Build.SourcesDirectory)
        echo ""
        echo "=== Build Output Directory ==="
        find $(Build.SourcesDirectory) -name "bin" -type d -exec ls -la {} \; 2>/dev/null || echo "Build bin directory not found"
        echo ""
        echo "=== Compiled Application ==="
        find $(Build.SourcesDirectory) -name "*.dll" -o -name "basic-dotnet-webapp" | head -10
        echo ""
        echo "=== Application Configuration ==="
        cat appsettings.json || echo "appsettings.json not found"
        echo ""
        echo "=== Project File ==="
        cat *.csproj
        echo ""
        echo "=== Build Verification ==="
        dotnet --info
        echo ""
        echo "=== Application Successfully Built and Ready ==="
      displayName: 'Show Application Information and Build Output'
    
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests (if any)'
      inputs:
        command: 'test'
        projects: '**/*[Tt]ests/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --verbosity normal'
      continueOnError: true
      condition: succeeded()
    
    - task: DotNetCoreCLI@2
      displayName: 'Publish Application'
      inputs:
        command: 'publish'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: true
        modifyOutputPath: true
    
    - script: |
        echo "=== Published Files ==="
        ls -la $(Build.ArtifactStagingDirectory)
        echo ""
        echo "=== Application Ready for Deployment ==="
        echo "Published to: $(Build.ArtifactStagingDirectory)"
      displayName: 'Show Published Output'
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'dotnet-webapp'
        publishLocation: 'Container'

- stage: DeployToAzure
  displayName: 'Deploy to Azure Web App'
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq('${{ parameters.enableDeployment }}', true))
  jobs:
  - deployment: DeployWebApp
    displayName: 'Deploy to Azure Web App Service'
    environment: 'production'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadBuildArtifacts@0
            displayName: 'Download Build Artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'dotnet-webapp'
              downloadPath: '$(System.ArtifactsDirectory)'
          
          - task: AzureWebApp@1
            displayName: 'Deploy to Azure Web App'
            inputs:
              azureSubscription: '${{ parameters.azureServiceConnection }}'
              appType: 'webApp'
              appName: '${{ parameters.webAppName }}'
              resourceGroupName: '${{ parameters.resourceGroupName }}'
              package: '$(System.ArtifactsDirectory)/dotnet-webapp/**/*.zip'
              deploymentMethod: 'auto'
          
          - task: AzureAppServiceManage@0
            displayName: 'Restart Azure Web App'
            inputs:
              azureSubscription: '${{ parameters.azureServiceConnection }}'
              action: 'Restart Azure App Service'
              webAppName: '${{ parameters.webAppName }}'
              resourceGroupName: '${{ parameters.resourceGroupName }}'
          
          - script: |
              echo "=================================="
              echo "   DEPLOYMENT TO AZURE COMPLETE   "
              echo "=================================="
              echo ""
              echo "‚úÖ Application deployed successfully!"
              echo "üåê Web App Name: ${{ parameters.webAppName }}"
              echo "üì¶ Resource Group: ${{ parameters.resourceGroupName }}"
              echo "üîó Application URL: https://${{ parameters.webAppName }}.azurewebsites.net"
              echo ""
              echo "=== DEPLOYMENT SUMMARY ==="
              echo "‚Ä¢ .NET 10 application deployed"
              echo "‚Ä¢ Azure Web App Service updated"
              echo "‚Ä¢ Application restarted"
              echo "‚Ä¢ Ready to serve traffic"
              echo ""
              echo "Visit your application at:"
              echo "https://${{ parameters.webAppName }}.azurewebsites.net"
            displayName: 'Deployment Success Message'

- stage: DisplayResults
  displayName: 'Display Pipeline Results'
  dependsOn: 
    - BuildAndTest
    - DeployToAzure
  condition: always()
  jobs:
  - job: ShowResults
    displayName: 'Show Pipeline Results'
    steps:
    - script: |
        echo "=================================="
        echo "    BASIC .NET APP PIPELINE      "
        echo "=================================="
        echo ""
        echo "Pipeline Status: COMPLETED"
        echo "Build ID: $(Build.BuildId)"
        echo "Build Number: $(Build.BuildNumber)"
        echo "Repository: $(Build.Repository.Name)"
        echo "Branch: $(Build.SourceBranch)"
        echo "Commit: $(Build.SourceVersion)"
        echo ""
        echo "=== PIPELINE SUMMARY ==="
        echo "‚úì .NET SDK Installed"
        echo "‚úì Dependencies Restored"
        echo "‚úì Application Built Successfully"
        echo "‚úì Build Output Verified"
        echo "‚úì Application Information Displayed"
        echo "‚úì Build Artifacts Published"
        if [ '${{ parameters.enableDeployment }}' = 'True' ]; then
          echo "‚úì Deployed to Azure Web App Service"
          echo "üåê Application URL: https://${{ parameters.webAppName }}.azurewebsites.net"
        else
          echo "‚ÑπÔ∏è  Deployment skipped (enableDeployment = false)"
        fi
        echo ""
        echo "=== APPLICATION READY ==="
        echo "‚Ä¢ Web application built for net10.0"
        if [ '${{ parameters.enableDeployment }}' = 'True' ]; then
          echo "‚Ä¢ Successfully deployed to Azure"
          echo "‚Ä¢ Live at: https://${{ parameters.webAppName }}.azurewebsites.net"
        else
          echo "‚Ä¢ Ready for deployment to Azure"
        fi
        echo "‚Ä¢ Artifacts available for download"
        echo ""
        echo "=== NEXT STEPS ==="
        if [ '${{ parameters.enableDeployment }}' = 'True' ]; then
          echo "1. Test your deployed application"
          echo "2. Monitor application performance"
          echo "3. Set up monitoring and alerts"
        else
          echo "1. Set up Azure Service Connection"
          echo "2. Enable deployment by setting enableDeployment=true"
          echo "3. Configure Azure Web App parameters"
        fi
        echo ""
        echo "Pipeline completed successfully!"
      displayName: 'Pipeline Summary'