# Azure DevOps Pipeline for Basic Modern Dotnet WebApp
# This pipeline builds and optionally deploys the .NET 8.0 web application to Azure App Service

trigger:
  branches:
    include:
    - main
    - develop

parameters:
- name: enableDeployment
  displayName: 'Enable Deployment Stages'
  type: boolean
  default: false
- name: azureServiceConnection
  displayName: 'Azure Service Connection Name'
  type: string
  default: 'Azure-BasicDotnetApp-Connection'
- name: webAppName
  displayName: 'Azure Web App Name'
  type: string
  default: 'basic-modern-dotnet-webapp'
- name: resourceGroupName
  displayName: 'Azure Resource Group Name'
  type: string
  default: 'rg-basic-dotnet-webapp'

variables:
  # Build Variables
  buildConfiguration: 'Release'
  dotNetFramework: 'net8.0'
  dotNetVersion: '8.0.x'
  targetRuntime: 'win-x64'

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: Build
    displayName: 'Build Job'
    pool:
      vmImage: 'windows-latest'
    
    steps:
    - task: PowerShell@2
      displayName: 'Pipeline Configuration'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "=== Pipeline Configuration ===" -ForegroundColor Green
          Write-Host "Deployment Enabled: ${{ parameters.enableDeployment }}"
          Write-Host "Service Connection: ${{ parameters.azureServiceConnection }}"
          Write-Host "Web App Name: ${{ parameters.webAppName }}"
          Write-Host "Resource Group: ${{ parameters.resourceGroupName }}"
          Write-Host "Branch: $(Build.SourceBranch)"
          Write-Host ""
          
          if ("${{ parameters.enableDeployment }}" -eq "False") {
            Write-Host "‚ÑπÔ∏è  Deployment stages are disabled." -ForegroundColor Yellow
            Write-Host "   To enable deployments:" -ForegroundColor Yellow
            Write-Host "   1. Set up Azure service connection: ${{ parameters.azureServiceConnection }}" -ForegroundColor Yellow
            Write-Host "   2. Run pipeline with 'enableDeployment' = true" -ForegroundColor Yellow
            Write-Host "   3. Or use the automated setup: ./setup-service-connection.sh" -ForegroundColor Yellow
          } else {
            Write-Host "‚úÖ Deployment stages are enabled!" -ForegroundColor Green
          }
    
    - task: UseDotNet@2
      displayName: 'Install .NET SDK'
      inputs:
        packageType: 'sdk'
        version: $(dotNetVersion)
        includePreviewVersions: false
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet Packages'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'
        feedsToUse: 'select'
    
    - task: DotNetCoreCLI@2
      displayName: 'Build Application'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-restore'
    
    - task: DotNetCoreCLI@2
      displayName: 'Run Unit Tests'
      inputs:
        command: 'test'
        projects: '**/*Test*.csproj'
        arguments: '--configuration $(buildConfiguration) --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory $(Agent.TempDirectory)'
      continueOnError: true
    
    - task: PublishCodeCoverageResults@1
      displayName: 'Publish Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'
      condition: succeededOrFailed()
    
    - task: DotNetCoreCLI@2
      displayName: 'Publish Application'
      inputs:
        command: 'publish'
        publishWebProjects: true
        arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory) --no-restore --no-build --runtime $(targetRuntime) --self-contained false'
        zipAfterPublish: true
        modifyOutputPath: false
    
    - task: PublishBuildArtifacts@1
      displayName: 'Publish Build Artifacts'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'webapp-artifacts'
        publishLocation: 'Container'

# Conditional Deployment Stages - Only included when enableDeployment is true
${{ if eq(parameters.enableDeployment, true) }}:
  - stage: Deploy_Development
    displayName: 'Deploy to Development'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
    jobs:
    - deployment: Deploy_Dev
      displayName: 'Deploy to Dev Environment'
      pool:
        vmImage: 'windows-latest'
      environment: 'Development'
      variables:
        webAppName: '${{ parameters.webAppName }}-dev'
      strategy:
        runOnce:
          deploy:
            steps:
            - task: AzureWebApp@1
              displayName: 'Deploy to Azure Web App (Dev)'
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                appType: 'webApp'
                appName: '$(webAppName)'
                resourceGroupName: '${{ parameters.resourceGroupName }}'
                package: '$(Pipeline.Workspace)/webapp-artifacts/**/*.zip'
                deploymentMethod: 'auto'
                appSettings: |
                  -ASPNETCORE_ENVIRONMENT Development
                  -ASPNETCORE_HTTP_PORTS 80

  - stage: Deploy_Production
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
    - deployment: Deploy_Prod
      displayName: 'Deploy to Production Environment'
      pool:
        vmImage: 'windows-latest'
      environment: 'Production'
      strategy:
        runOnce:
          deploy:
            steps:
            - task: AzureWebApp@1
              displayName: 'Deploy to Azure Web App (Production)'
              inputs:
                azureSubscription: '${{ parameters.azureServiceConnection }}'
                appType: 'webApp'
                appName: '${{ parameters.webAppName }}'
                resourceGroupName: '${{ parameters.resourceGroupName }}'
                package: '$(Pipeline.Workspace)/webapp-artifacts/**/*.zip'
                deploymentMethod: 'auto'
                appSettings: |
                  -ASPNETCORE_ENVIRONMENT Production
                  -ASPNETCORE_HTTP_PORTS 80
                  -ASPNETCORE_HTTPS_PORT 443

  - stage: HealthCheck
    displayName: 'Health Check'
    dependsOn: 
    - Deploy_Development
    - Deploy_Production
    condition: or(succeeded('Deploy_Development'), succeeded('Deploy_Production'))
    jobs:
    - job: HealthCheck
      displayName: 'Verify Deployment'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
      - task: PowerShell@2
        displayName: 'Health Check - Production'
        inputs:
          targetType: 'inline'
          script: |
            $url = "https://${{ parameters.webAppName }}.azurewebsites.net"
            Write-Host "Checking health of: $url"
            
            try {
              $response = Invoke-WebRequest -Uri $url -TimeoutSec 30
              if ($response.StatusCode -eq 200) {
                Write-Host "‚úÖ Health check passed! Status: $($response.StatusCode)"
              } else {
                Write-Warning "‚ö†Ô∏è Unexpected status code: $($response.StatusCode)"
              }
            } catch {
              Write-Error "‚ùå Health check failed: $($_.Exception.Message)"
              exit 1
            }
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')

# Summary stage always runs
- stage: Summary
  displayName: 'Pipeline Summary'
  dependsOn: Build
  condition: always()
  jobs:
  - job: Summary
    displayName: 'Show Pipeline Status'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: PowerShell@2
      displayName: 'Pipeline Summary'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "=== Pipeline Execution Summary ===" -ForegroundColor Green
          Write-Host ""
          Write-Host "Configuration:"
          Write-Host "  Branch: $(Build.SourceBranch)"
          Write-Host "  Deployment Enabled: ${{ parameters.enableDeployment }}"
          Write-Host "  Service Connection: ${{ parameters.azureServiceConnection }}"
          Write-Host ""
          
          if ("${{ parameters.enableDeployment }}" -eq "False") {
            Write-Host "üì¶ Build completed successfully!" -ForegroundColor Green
            Write-Host "üîß Ready to deploy when service connection is set up." -ForegroundColor Yellow
            Write-Host ""
            Write-Host "Next Steps:" -ForegroundColor Cyan
            Write-Host "1. Run: ./setup-service-connection.sh"
            Write-Host "2. Create service connection in Azure DevOps"
            Write-Host "3. Run pipeline again with enableDeployment=true"
          } else {
            Write-Host "üöÄ Full pipeline execution completed!" -ForegroundColor Green
            Write-Host "‚úÖ Build and deployment stages executed." -ForegroundColor Green
          }